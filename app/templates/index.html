{% extends "base.html" %} {% block title %}Tukey 預測結果{% endblock %} {% block
content %}
<!-- Loading 動畫 -->
<div id="loading">
  <div class="d-flex justify-content-center align-items-center flex-column">
    <div class="spinner-border text-primary" role="status"></div>
    <span class="mt-2">Processing... Please wait.</span>
  </div>
</div>

<!-- 主要內容 -->
<div class="container my-4">
  <!-- XGB 預測結果 -->

  <div class="card mb-4">
    <div class="card-body">
      <h2 class="card-title">
        隔天 ({{ next_day }}) 價格預測 (Tukey Regressor)
      </h2>
      <p class="card-text text-danger fs-5">
        預測值 (隔日): <b>{{ tukey_pred }}</b>
      </p>
      <a href="/tukey_form" class="btn">自訂輸入</a>
      <a href="/tukey_form_noDate" class="btn">自訂輸入(不含日期)</a>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <h2 class="card-title">隔天 ({{ next_day }}) 價格預測 (XGB Regressor)</h2>
      <p class="card-text text-danger fs-5">
        預測值 (隔日): <b>{{ xgb_pred }}</b>
      </p>
      <a href="/xgb_form" class="btn">自訂 XGB 輸入</a>
    </div>
  </div>

  <!-- Prophet 預測結果 -->
  <div class="card mb-4">
    <div class="card-body">
      <h2 class="card-title">隔天 ({{ next_day }}) 價格預測 (Prophet)</h2>
      <p class="card-text text-danger fs-5">
        預測值 (隔日): <b>{{ prophet_fvalue }}</b>
      </p>
    </div>
  </div>

  <!-- Latest Forecast 表格 -->
  <div class="card mb-4">
    <div class="card-body">
      <h2 class="card-title">未來Prophet預測值</h2>
      <!-- 建議加個容器 class 方便管理整個區塊空間 -->
      <div class="table-container table-responsive prophet-table">
        {{ future_table_html|safe }}
      </div>
    </div>
  </div>

  <!-- 圖表 -->
  <div class="row">
    <div class="col-md-6 mb-4">
      <h3>Prophet Plot A - 全歷史圖</h3>
      <canvas id="prophetChart" width="500" height="400"></canvas>
    </div>
    <div class="col-md-6 mb-4">
      <h3>Prophet Plot B - 最近 15日 + 未來 7日</h3>
      <canvas id="recentFutureChart" width="500" height="400"></canvas>
    </div>
  </div>

  <!-- Append and Train 按鈕 -->
  <div class="text-center">
    <button id="appendAndTrainBtn" class="btn btn-lg">更新和重訓資料</button>
  </div>
</div>

<!-- <div class="card mb-4">
  <div class="card-body">
    <h2 class="card=title">Prophet 互動圖表</h2>
    <canvas id="prophetChart" width="800" height="400"></canvas>
  </div>
</div> -->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // 同時抓 "歷史" + "預測" API
    Promise.all([
      fetch("/api/historical_data").then((res) => res.json()),
      fetch("/api/prophet_forecast").then((res) => res.json()),
    ])
      .then(([histData, forecastData]) => {
        console.log("Historical data:", histData);
        console.log("Forecast data:", forecastData);

        // 1) 把 ds 轉成 x軸, y, yhat, yhat_lower, yhat_upper 轉 float
        //   histData: [ {ds:"2024-01-01", y:580}, ... ]
        //   forecastData: [ {ds:"2024-01-01",yhat:...,yhat_lower:...,yhat_upper:...}, ...]

        // 2) 取得所有 ds(日期), 排序去重
        const allDates = new Set([
          ...histData.map((d) => d.ds),
          ...forecastData.map((d) => d.ds),
        ]);
        const sortedDates = Array.from(allDates).sort(
          (a, b) => new Date(a) - new Date(b)
        );

        // 3) 組合 chart datasets
        //   A) 實際 y - 當作 scatter
        const histScatter = {
          label: "實際值 (散點)",
          data: sortedDates
            .map((ds) => {
              // 查 histData 中 ds
              const row = histData.find((item) => item.ds === ds);
              return row ? { x: ds, y: row.y } : null;
            })
            .filter((pt) => pt !== null), // 過濾掉 null
          showLine: false,
          pointRadius: 1,
          borderColor: "black",
          backgroundColor: "black",
        };

        //   B) 預測主線 (yhat)
        const yhatLine = {
          label: "預測值",
          data: sortedDates
            .map((ds) => {
              const row = forecastData.find((item) => item.ds === ds);
              return row ? { x: ds, y: row.yhat } : null;
            })
            .filter((pt) => pt !== null), // 過濾掉 null
          borderColor: "#87CEFA",
          borderWidth: 1, // 粗細
          fill: false,
          tension: 0.1,
        };

        //   C) 下界 (yhat_lower)
        const lowerLine = {
          label: "預測信賴區間下界",
          data: sortedDates
            .map((ds) => {
              const row = forecastData.find((item) => item.ds === ds);
              return row ? { x: ds, y: row.yhat_lower } : null;
            })
            .filter((pt) => pt !== null), // 過濾掉 null
          borderColor: "rgba(0,0,0,0)", //隱藏線
          pointRadius: 0,
          fill: false,
        };

        //   D) 上界 (yhat_upper) + fill
        const upperLine = {
          label: "信賴區間",
          data: sortedDates
            .map((ds) => {
              const row = forecastData.find((item) => item.ds === ds);
              return row ? { x: ds, y: row.yhat_upper } : null;
            })
            .filter((pt) => pt !== null), // 過濾掉 null
          borderColor: "rgba(0,0,0,0)",
          backgroundColor: "rgba(0,0,255,0.2)",
          pointRadius: 0,
          fill: "-1", // 跟前一條 (lowerLine) 之間做 fill
        };

        console.log("histScatter data array:", histScatter.data);
        console.log("yhatLine data array:", yhatLine.data);

        // Chart資料
        const chartData = {
          labels: sortedDates, // 只是用來顯示x軸
          datasets: [histScatter, lowerLine, upperLine, yhatLine],
        };

        // Chart options
        const options = {
          responsive: true,
          //parsing: false, // 告訴Chart.js我們手動提供{x,y}
          scales: {
            x: {
              type: "time", // Chart.js 3+ 支援 time 軸
              time: {
                parser: "yyyy-MM-dd", // ds格式
                unit: "day",
                displayFormats: {
                  day: "yyyy-MM-dd",
                },
              },
              title: { display: true, text: "Date" },
            },
            y: {
              title: { display: true, text: "CPC 價格" },
            },
          },
          interaction: {
            mode: "index",
            intersect: false,
          },
          plugins: {
            tooltip: { enabled: true },
            legend: { display: true },
            title: {
              display: false,
              text: "Prophet 預測值 + 信賴區間 + 實際 y(散點)",
            },
          },
        };

        // 建立 Chart
        const ctx = document.getElementById("prophetChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: chartData,
          options: options,
        });
      })
      .catch((err) => {
        console.error("Error retrieving forecast/hist data", err);
      });
  });
</script>

<!-- <div class="card mb-4">
    <div class="card-body">
      <h2>Chart: 最近15天 + 未來7天</h2>
      <canvas id="recentFutureChart" width="800" height="400"></canvas>
    </div>
  </div> -->

<script>
  document.addEventListener("DOMContentLoaded", () => {
    fetch("/api/prophet_recent_future")
      .then((res) => res.json())
      .then((data) => {
        console.log("recent_future data:", data);
        // data = { recent15:[{ds,y},...], future7:[{ds,yhat,yhat_lower,yhat_upper},...] }

        const recent15 = data.recent15 || [];
        const future7 = data.future7 || [];

        // 1) recent15: black line? or black scatter?
        //   =>  參考 matplotlib: 'ko-' => black circle with line
        //   -> in Chart.js, you can do showLine:true + pointRadius:3, color:'black'
        const recentDataset = {
          label: "最近15日實際值",
          data: recent15.map((r) => ({
            x: r.ds,
            y: r.y,
          })),
          borderColor: "black",
          backgroundColor: "black",
          showLine: true,
          pointRadius: 4,
          fill: false,
        };

        // 2) future line => 'b--' => blue dotted
        const futureLine = {
          label: "未來7日預測值",
          data: future7.map((r) => ({
            x: r.ds,
            y: r.yhat,
          })),
          borderColor: "blue",
          borderDash: [5, 5], // dotted
          fill: false,
          tension: 0.1,
        };

        // 3) conf interval => fillBetween(yhat_lower,yhat_upper)
        //   => two dataset: lowerLine(transparent), upperLine with fill:'-1'
        const futureLower = {
          label: "預測信賴區間下界",
          data: future7.map((r) => ({
            x: r.ds,
            y: r.yhat_lower,
          })),
          borderColor: "rgba(0,0,0,0)", // hidden
          pointRadius: 0,
          fill: false,
        };

        const futureUpper = {
          label: "信賴區間",
          data: future7.map((r) => ({
            x: r.ds,
            y: r.yhat_upper,
          })),
          borderColor: "rgba(0,0,0,0)",
          backgroundColor: "rgba(0,0,255,0.2)",
          pointRadius: 0,
          fill: "-1", // fill area between this & previous dataset
        };

        // 4) Chart data
        const allData = [
          ...recent15.map((d) => d.ds),
          ...future7.map((d) => d.ds),
        ];
        // sort them
        const sortedDates = Array.from(new Set(allData)).sort(
          (a, b) => new Date(a) - new Date(b)
        );

        const chartData = {
          labels: sortedDates, // x軸 label
          datasets: [recentDataset, futureLower, futureUpper, futureLine],
        };

        const ctx = document
          .getElementById("recentFutureChart")
          .getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: chartData,
          options: {
            responsive: true,
            //parsing: false, // we provide {x,y} ourselves
            scales: {
              x: {
                type: "time",
                time: {
                  parser: "yyyy-MM-dd",
                  unit: "day",
                  displayFormats: { day: "yyyy-MM-dd" },
                },
                title: { display: true, text: "Date" },
              },
              y: {
                title: { display: true, text: "CPC 價格" },
              },
            },
            plugins: {
              legend: { display: true },
              title: {
                display: false,
                text: "Prophet - Recent 15 Days + Next 7 Days (Interactive)",
              },
            },
          },
        });
      })
      .catch((err) => {
        console.error("Error get /api/prophet_recent_future", err);
      });
  });
</script>

<script>
  $(document).ready(function () {
    $("#appendAndTrainBtn").on("click", function () {
      $("#loading").show(); // 顯示 loading 動畫
      $(this).prop("disabled", true); // 禁用按鈕
      $.ajax({
        url: "/append_and_train",
        type: "POST",
        success: function (response) {
          $("#loading").hide(); // 隱藏 loading 動畫
          $("#appendAndTrainBtn").prop("disabled", false); // 啟用按鈕
          alert(response.message); // 顯示伺服器返回的提示訊息
          location.reload(); // 刷新頁面以更新內容
        },
        error: function () {
          $("#loading").hide();
          $("#appendAndTrainBtn").prop("disabled", false); // 啟用按鈕
          alert("An error occurred while processing.");
        },
      });
    });
  });
</script>

{% endblock %}
